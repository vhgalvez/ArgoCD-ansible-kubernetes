# playbooks/01_generate-auth-secret.yml
# 🔐 Generar y sellar el Secret de autenticación básica para el Dashboard de Argo CD
---
- name: 🔐 Generar y sellar el Secret de basic-auth para el Dashboard de Argo CD
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    files_dir: "{{ playbook_dir }}/files"
    secret_template: "../templates/secrets/basic-auth-secret.yaml.j2"
    rendered_unsealed_secret_path: "{{ files_dir }}/argocd-dashboard-secret-unsealed.yaml"
    sealed_secret_path:         "{{ files_dir }}/argocd-dashboard-sealed.yaml"

  tasks:
    ######################################################################
    # 1. Requisitos previos
    ######################################################################
    - name: 📋 Verificar kubeseal
      stat: { path: "{{ kubeseal_path }}" }
      register: kubeseal_check

    - fail: msg="❌ kubeseal no encontrado en {{ kubeseal_path }}"
      when: not kubeseal_check.stat.exists

    - name: ⚙️ Verificar variables ARGOCD_AUTH_*
      fail:
        msg: "❌ ARGOCD_AUTH_USER y/o ARGOCD_AUTH_PASS no definidos."
      when: argocd_auth_user|default('') == '' or argocd_auth_pass|default('') == ''

    ######################################################################
    # 2. htpasswd
    ######################################################################
    - name: 📊 Recoger facts mínimos
      ansible.builtin.setup:
        gather_subset: ['!all', 'min']

    - name: 📦 Instalar herramienta htpasswd
      ansible.builtin.package:
        name: "{{ (ansible_facts.os_family == 'RedHat') | ternary('httpd-tools','apache2-utils') }}"
        state: present
      become: true

    - name: 🔑 Generar línea htpasswd bcrypt
      shell: echo "{{ argocd_auth_pass }}" | htpasswd -i -B -n "{{ argocd_auth_user }}"
      register: htpasswd_line
      no_log: true

    - set_fact:
        basic_auth: "{{ htpasswd_line.stdout | b64encode }}"

    ######################################################################
    # 3. Directorio y renderizado
    ######################################################################
    - name: 📂 Asegurar directorio {{ files_dir }} con permisos de escritura
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: '0700'

    - name: 📝 Renderizar Secret no sellado
      template:
        src: "{{ secret_template }}"
        dest: "{{ rendered_unsealed_secret_path }}"
      vars:
        namespace_tpl: "{{ argocd_namespace }}"
        secret_name:   "argocd-dashboard-auth"
        basic_auth:    "{{ basic_auth }}"

    ######################################################################
    # 4. Sellar y aplicar
    ######################################################################
    - name: 🔐 Sellar con kubeseal
      shell: >
        {{ kubeseal_path }}
        --controller-name sealed-secrets-controller
        --controller-namespace kube-system
        --format yaml
        < {{ rendered_unsealed_secret_path }} > {{ sealed_secret_path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: true

    - file:
        path: "{{ rendered_unsealed_secret_path }}"
        state: absent
      changed_when: false

    - name: 🚀 Aplicar SealedSecret
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ sealed_secret_path }}
      register: apply_res
      changed_when: "'created' in apply_res.stdout or 'configured' in apply_res.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"