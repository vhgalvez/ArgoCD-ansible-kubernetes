# playbooks/uninstall_argocd.yml
---
- name: üóëÔ∏è Desinstalar ArgoCD y sus recursos relacionados
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # üåê Ingress & Middleware
    - name: ‚ùå Eliminar IngressRoute del Dashboard de ArgoCD
      kubernetes.core.k8s:
        state: absent
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: ingressroute-argocd-internal
            namespace: "{{ argocd_namespace }}"
      tags: [argocd, ingressroute]

    - name: ‚ùå Eliminar Middleware de autenticaci√≥n de ArgoCD
      kubernetes.core.k8s:
        state: absent
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: "{{ argocd_middleware_name }}"
            namespace: "{{ argocd_namespace }}"
      tags: [argocd, middleware]

    # üîê Autenticaci√≥n
    - name: ‚ùå Eliminar SealedSecret de autenticaci√≥n b√°sica
      kubernetes.core.k8s:
        state: absent
        definition:
          apiVersion: bitnami.com/v1alpha1
          kind: SealedSecret
          metadata:
            name: "{{ argocd_secret_name }}"
            namespace: "{{ argocd_namespace }}"
      tags: [argocd, sealedsecret]

    - name: ‚ùå Eliminar Secret de autenticaci√≥n sin sellar
      kubernetes.core.k8s:
        state: absent
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ argocd_secret_name }}"
            namespace: "{{ argocd_namespace }}"
      tags: [argocd, secret]

    - name: ‚ùå Eliminar Secret de contrase√±a admin de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kind: Secret
        api_version: v1
        name: argocd-secret
        namespace: "{{ argocd_namespace }}"
      ignore_errors: true
      tags: [argocd, secret]

    # ‚öôÔ∏è ConfigMaps
    - name: ‚ùå Eliminar ConfigMap argocd-cm
      kubernetes.core.k8s:
        state: absent
        kind: ConfigMap
        api_version: v1
        name: argocd-cm
        namespace: "{{ argocd_namespace }}"
      ignore_errors: true
      tags: [argocd, configmap]

    - name: ‚ùå Eliminar ConfigMap argocd-cmd-params-cm
      kubernetes.core.k8s:
        state: absent
        kind: ConfigMap
        api_version: v1
        name: argocd-cmd-params-cm
        namespace: "{{ argocd_namespace }}"
      ignore_errors: true
      tags: [argocd, configmap]

    # üë§ ServiceAccounts
    - name: ‚ùå Eliminar ServiceAccount de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kind: ServiceAccount
        api_version: v1
        name: argocd-server
        namespace: "{{ argocd_namespace }}"
      ignore_errors: true
      tags: [argocd, serviceaccount]

    # üîê RBAC
    - name: ‚ùå Eliminar ClusterRoleBinding de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kind: ClusterRoleBinding
        api_version: rbac.authorization.k8s.io/v1
        name: argocd-server
      ignore_errors: true
      tags: [argocd, rbac]

    - name: ‚ùå Eliminar ClusterRole de ArgoCD Server
      kubernetes.core.k8s:
        state: absent
        kind: ClusterRole
        api_version: rbac.authorization.k8s.io/v1
        name: argocd-server
      ignore_errors: true
      tags: [argocd, rbac]

    - name: ‚ùå Eliminar ClusterRole de ArgoCD Application Controller
      kubernetes.core.k8s:
        state: absent
        kind: ClusterRole
        api_version: rbac.authorization.k8s.io/v1
        name: argocd-application-controller
      ignore_errors: true
      tags: [argocd, rbac]

    # üß¨ CRDs
    - name: ‚ùå Eliminar CRDs de ArgoCD
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
        delete crd applications.argoproj.io applicationsets.argoproj.io
        appprojects.argoproj.io argocdextensions.argoproj.io
      ignore_errors: true
      changed_when: true
      tags: [argocd, crd]

    # üì¶ Helm release
    - name: ‚ùå Eliminar release Helm de ArgoCD
      command: >
        {{ helm_path }} uninstall argocd --namespace {{ argocd_namespace }}
      register: helm_uninstall
      failed_when: false
      changed_when: '''release "argocd" uninstalled'' in helm_uninstall.stdout'
      ignore_errors: true
      tags: [argocd, helm]

    # üßπ Namespace
    - name: üßπ Eliminar namespace completo de ArgoCD
      kubernetes.core.k8s:
        name: "{{ argocd_namespace }}"
        api_version: v1
        kind: Namespace
        state: absent
      tags: [argocd, namespace]

    - name: ‚ùå Eliminar ClusterRoleBinding de ArgoCD Application Controller
      kubernetes.core.k8s:
        state: absent
        kind: ClusterRoleBinding
        api_version: rbac.authorization.k8s.io/v1
        name: argocd-application-controller
      ignore_errors: true
      tags: [argocd, rbac]
