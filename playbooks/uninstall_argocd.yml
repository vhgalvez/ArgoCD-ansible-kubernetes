# playbooks/uninstall_argocd.yml
---
- name: üóëÔ∏è Desinstalar ArgoCD y sus recursos relacionados
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - name: ‚ùå Eliminar IngressRoute del Dashboard de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: IngressRoute
          metadata:
            name: ingressroute-argocd-internal
            namespace: "{{ argocd_namespace }}"

    - name: ‚ùå Eliminar Middleware de autenticaci√≥n de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: "{{ argocd_middleware_name }}"
            namespace: "{{ argocd_namespace }}"

    - name: ‚ùå Eliminar SealedSecret de autenticaci√≥n b√°sica
      kubernetes.core.k8s:
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: bitnami.com/v1alpha1
          kind: SealedSecret
          metadata:
            name: "{{ argocd_secret_name }}"
            namespace: "{{ argocd_namespace }}"

    - name: ‚ùå Eliminar Secret de autenticaci√≥n si existe sin sellar
      kubernetes.core.k8s:
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ argocd_secret_name }}"
            namespace: "{{ argocd_namespace }}"

    - name: ‚ùå Eliminar Secret de contrase√±a admin de ArgoCD
      kubernetes.core.k8s:
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-secret
            namespace: "{{ argocd_namespace }}"

    - name: üßπ Eliminar namespace completo de ArgoCD
      kubernetes.core.k8s:
        name: "{{ argocd_namespace }}"
        api_version: v1
        kind: Namespace
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"