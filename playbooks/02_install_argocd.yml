# playbooks/02_install_argocd.yml
# ğŸŒ ConfiguraciÃ³n de acceso web de ArgoCD: Middleware Traefik + IngressRoute + Secret UI + TLS

---
- name: ğŸŒ Aplicar configuraciÃ³n de acceso web para ArgoCD
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    mw_auth_template: "../templates/argocd/argocd-dashboard-middleware-auth.yaml.j2"
    ir_template: "../templates/argocd/argocd-dashboard-ingressroute-internal.yaml.j2"
    cm_template: "../templates/argocd/argocd-cm.yaml.j2"
    cmd_template: "../templates/argocd/argocd-cmd-params-cm.yaml.j2"

    mw_auth_manifest: "{{ playbook_dir }}/files/argocd-dashboard-middleware-auth.yaml"
    ir_manifest: "{{ playbook_dir }}/files/argocd-dashboard-ingressroute.yaml"
    cm_rendered: "{{ playbook_dir }}/files/argocd-cm.yaml"
    cmd_rendered: "{{ playbook_dir }}/files/argocd-cmd-params-cm.yaml"

  tasks:
    # ğŸ•’ Esperar a que el servidor ArgoCD estÃ© disponible
    - name: â³ Esperar que argocd-server estÃ© disponible
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: argocd-server
        namespace: "{{ argocd_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: deploy_info
      until: >
        deploy_info.resources
        and deploy_info.resources[0].status.availableReplicas is defined
        and deploy_info.resources[0].status.availableReplicas | int > 0
      retries: 30
      delay: 10

    # ğŸ” Hashear la contraseÃ±a del admin de Argo CD UI
    - name: ğŸ” Hashear la contraseÃ±a del admin
      command: "htpasswd -nbBC 12 '' '{{ argocd_admin_password_plain }}'"
      register: bcrypt_password_raw
      changed_when: false

    - name: ğŸ§  Extraer hash de la salida
      set_fact:
        argocd_admin_password_hash: "{{ bcrypt_password_raw.stdout.split(':')[-1] }}"

    - name: ğŸ—ï¸ Crear o actualizar el Secret argocd-secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ argocd_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: argocd-secret
          type: Opaque
          stringData:
            admin.password: "{{ argocd_admin_password_hash }}"
            admin.passwordMtime: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    # ğŸ§© ConfigMap con el dominio externo de la UI
    - name: ğŸ“„ Renderizar plantilla del ConfigMap
      template:
        src: "{{ cm_template }}"
        dest: "{{ cm_rendered }}"

    - name: ğŸš€ Aplicar ConfigMap
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ cm_rendered }}
      register: cm_result
      changed_when: "'created' in cm_result.stdout or 'configured' in cm_result.stdout"

    # ğŸ§© Middleware de autenticaciÃ³n (Traefik)
    - name: ğŸ“„ Renderizar middleware auth
      template:
        src: "{{ mw_auth_template }}"
        dest: "{{ mw_auth_manifest }}"

    - name: ğŸš€ Aplicar middleware auth
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ mw_auth_manifest }}
      register: mw_auth_result
      changed_when: "'created' in mw_auth_result.stdout or 'configured' in mw_auth_result.stdout"

    # ğŸ§© IngressRoute protegido con middleware
    - name: ğŸ“„ Renderizar IngressRoute
      template:
        src: "{{ ir_template }}"
        dest: "{{ ir_manifest }}"

    - name: ğŸš€ Aplicar IngressRoute
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ ir_manifest }}
      register: ir_result
      changed_when: "'created' in ir_result.stdout or 'configured' in ir_result.stdout"

    # ğŸ§© Desactivar TLS interno de ArgoCD
    - name: ğŸ“„ Renderizar argocd-cmd-params-cm
      template:
        src: "{{ cmd_template }}"
        dest: "{{ cmd_rendered }}"

    - name: ğŸš€ Aplicar argocd-cmd-params-cm
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ cmd_rendered }}
      register: cmd_cm_result
      changed_when: "'created' in cmd_cm_result.stdout or 'configured' in cmd_cm_result.stdout"

    # ğŸ” Reiniciar el servidor ArgoCD (por cambio de contraseÃ±a o config)
    - name: ğŸ” Reiniciar argocd-server
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
        rollout restart deployment argocd-server -n {{ argocd_namespace }}
      register: restart_result
      changed_when: "'restarted' in restart_result.stdout"

    # ğŸ§¹ Limpiar archivos temporales
    - name: ğŸ§¹ Borrar archivos temporales
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ mw_auth_manifest }}"
        - "{{ ir_manifest }}"
        - "{{ cm_rendered }}"
        - "{{ cmd_rendered }}"