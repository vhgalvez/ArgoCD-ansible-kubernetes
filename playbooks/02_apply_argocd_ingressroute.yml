# playbooks\02_apply_argocd_ingressroute.yml
---
- name: 🌐 Aplicar IngressRoute interna para ArgoCD (Traefik CRD)
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    template_file: "../templates/argocd/argocd-dashboard-ingressroute-internal.yaml.j2"
    rendered_manifest: "{{ playbook_dir }}/files/argocd-dashboard-ingressroute.yaml"

  tasks:
    - name: 📄 Renderizar plantilla de IngressRoute
      template:
        src: "{{ template_file }}"
        dest: "{{ rendered_manifest }}"

    - name: 🚀 Aplicar IngressRoute al clúster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ rendered_manifest }}
      register: result
      changed_when: "'created' in result.stdout or 'configured' in result.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: 🧹 Borrar manifiesto temporal
      file:
        path: "{{ rendered_manifest }}"
        state: absent