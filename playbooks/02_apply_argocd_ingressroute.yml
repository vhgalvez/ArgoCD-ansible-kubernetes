# playbooks/02_apply_argocd_ingressroute.yml
# ðŸŒ Aplicar Middleware + IngressRoute protegida para ArgoCD con Traefik
---
- name: ðŸŒ Aplicar IngressRoute interna protegida para ArgoCD (Traefik CRD)
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    mw_template: "../templates/argocd/argocd-dashboard-middleware.yaml.j2"
    ir_template: "../templates/argocd/argocd-dashboard-ingressroute-internal.yaml.j2"
    mw_manifest: "{{ playbook_dir }}/files/argocd-dashboard-middleware.yaml"
    ir_manifest: "{{ playbook_dir }}/files/argocd-dashboard-ingressroute.yaml"

  tasks:

    # âžŠ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Middleware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“„ Renderizar plantilla del Middleware (basic-auth)
      template:
        src: "{{ mw_template }}"
        dest: "{{ mw_manifest }}"

    - name: ðŸš€ Aplicar Middleware al clÃºster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ mw_manifest }}
      register: mw_result
      changed_when: "'created' in mw_result.stdout or 'configured' in mw_result.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # âž‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IngressRoute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“„ Renderizar plantilla del IngressRoute
      template:
        src: "{{ ir_template }}"
        dest: "{{ ir_manifest }}"

    - name: ðŸš€ Aplicar IngressRoute al clÃºster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ ir_manifest }}
      register: ir_result
      changed_when: "'created' in ir_result.stdout or 'configured' in ir_result.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # âžŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Limpieza â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ§¹ Borrar manifiestos temporales
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ mw_manifest }}"
        - "{{ ir_manifest }}"