# playbooks\02_apply_argocd_ingressroute.yml
---
- name: 🌐 Aplicar IngressRoute interna para ArgoCD (Traefik CRD)
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    template_file: "../templates/argocd/argocd-dashboard-ingressroute-internal.yaml.j2"
    rendered_manifest: "{{ playbook_dir }}/files/argocd-dashboard-ingressroute.yaml"

  tasks:
    - name: 📄 Renderizar plantilla de IngressRoute
      template:
        src: "{{ template_file }}"
        dest: "{{ rendered_manifest }}"

    - name: 🚀 Aplicar IngressRoute al clúster
      ansible.builtin.command:
        cmd: "{{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ rendered_manifest }}"
      register: apply_ingressroute_result
      changed_when: "'created' in apply_ingressroute_result.stdout or 'configured' in apply_ingressroute_result.stdout"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: 🧹 Eliminar manifiesto renderizado
      file:
        path: "{{ rendered_manifest }}"
        state: absent
