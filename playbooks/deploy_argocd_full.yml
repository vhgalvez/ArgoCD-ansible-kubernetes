# playbooks/deploy_argocd_full.yml -----------------------------------
# 📦 Instalación completa de ArgoCD con seguridad y exposición
- name: 📦 Instalación completa de ArgoCD con seguridad y exposición
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  pre_tasks:
    - name: ✅ Validar que kubeconfig esté definido
      assert:
        that: kubeconfig_path is defined
        msg: "❌ kubeconfig_path no definido"

# 0️⃣ Copiar Secret TLS (wildcard-socialdevs-tls)
- import_playbook: playbooks/00_copy_tls_secret.yml

# 1️⃣ Generar SealedSecret para autenticación Dashboard
- import_playbook: playbooks/01_generate-auth-secret.yml

# 2️⃣ Instalar ArgoCD y Secret de admin personalizado
- import_playbook: playbooks/03_install_argocd.yml

# 3️⃣ Aplicar IngressRoute protegida para el Dashboard
- import_playbook: playbooks/02_apply_argocd_ingressroute.yml

# 4️⃣ Verificar acceso al Dashboard (modo tolerante)
- name: 🌐 Verificar acceso al Dashboard (tolerante)
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  tasks:
    - name: 🌐 Comprobar acceso al Dashboard
      shell: >
        curl --http1.1 -k -u {{ argocd_auth_user }}:{{ argocd_auth_pass }}
        https://{{ argocd_dashboard_domain }}/
        --max-time 10 --silent --output /dev/null --write-out '%{http_code}'
      register: dashboard_status
      changed_when: false
      failed_when: dashboard_status.stdout not in ['200','302','401']

    - name: 🧪 Mostrar resultado HTTP
      debug:
        msg: "🌐 Código HTTP recibido: {{ dashboard_status.stdout }}"