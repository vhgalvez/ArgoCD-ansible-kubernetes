# playbooks/deploy_argocd_full.yml -----------------------------------
# ğŸ“¦ InstalaciÃ³n completa de ArgoCD con seguridad y exposiciÃ³n
- name: ğŸ“¦ InstalaciÃ³n completa de ArgoCD con seguridad y exposiciÃ³n
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  pre_tasks:
    - name: âœ… Validar que kubeconfig estÃ© definido
      assert:
        that: kubeconfig_path is defined
        msg: "âŒ kubeconfig_path no definido"

# 0ï¸âƒ£ Copiar Secret TLS (wildcard-socialdevs-tls)
- import_playbook: playbooks/00_copy_tls_secret.yml

# 1ï¸âƒ£ Generar SealedSecret para autenticaciÃ³n Dashboard
- import_playbook: playbooks/01_generate-auth-secret.yml

# 2ï¸âƒ£ Instalar ArgoCD y Secret de admin personalizado
- import_playbook: playbooks/03_install_argocd.yml

# 3ï¸âƒ£ Aplicar IngressRoute protegida para el Dashboard
- import_playbook: playbooks/02_apply_argocd_ingressroute.yml

# 4ï¸âƒ£ Verificar acceso al Dashboard (modo tolerante)
- name: ğŸŒ Verificar acceso al Dashboard (tolerante)
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  tasks:
    - name: ğŸŒ Comprobar acceso al Dashboard
      shell: >
        curl --http1.1 -k -u {{ argocd_auth_user }}:{{ argocd_auth_pass }}
        https://{{ argocd_dashboard_domain }}/
        --max-time 10 --silent --output /dev/null --write-out '%{http_code}'
      register: dashboard_status
      changed_when: false
      failed_when: dashboard_status.stdout not in ['200','302','401']

    - name: ğŸ§ª Mostrar resultado HTTP
      debug:
        msg: "ğŸŒ CÃ³digo HTTP recibido: {{ dashboard_status.stdout }}"