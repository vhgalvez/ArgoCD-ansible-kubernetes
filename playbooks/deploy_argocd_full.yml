# playbooks\deploy_argocd_full.yml
---
- name: ðŸš€ Desplegar ArgoCD completo con autenticaciÃ³n bÃ¡sica e IngressRoute
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  pre_tasks:
    - name: âš ï¸ Verificar que ARGOCD_AUTH_USER y PASS estÃ©n definidos
      fail:
        msg: "Faltan variables de entorno ARGOCD_AUTH_USER o ARGOCD_AUTH_PASS"
      when: argocd_auth_user is not defined or argocd_auth_pass is not defined

  tasks:

    - name: ðŸ” Generar y aplicar Secret sellado de autenticaciÃ³n bÃ¡sica
      import_playbook: 01_generate-auth-secret.yml

    - name: ðŸŽ¯ Desplegar ArgoCD (namespace, Secret, manifiestos e Ingress)
      import_playbook: deploy_argocd.yml

    - name: ðŸŒ Aplicar IngressRoute personalizado (Traefik CRD)
      import_playbook: 02_apply_argocd_ingressroute.yml

    - name: â±ï¸ Esperar a que el pod de argocd-server estÃ© listo
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=argocd-server"
      register: argocd_pods
      until: argocd_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
      retries: 20
      delay: 10

    - name: âœ… Mostrar acceso web
      debug:
        msg: "ArgoCD disponible en: https://{{ argocd_dashboard_domain }}"