# playbooks\deploy_argocd_full.yml
---
- name: ðŸš€ Desplegar ArgoCD completo con autenticaciÃ³n bÃ¡sica, Ingress y Traefik CRDs
  hosts: localhost
  connection: local
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml            # contiene kubeconfig, namespace, etc.

  #######################################################################
  # â–‘â–‘â–‘â–‘â–‘â–‘  PRE-TAREAS: leer .env y generar Secret sellado  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
  #######################################################################
  pre_tasks:
    - name: ðŸ“¥ Leer archivo .env local
      set_fact:
        env_lines: "{{ lookup('file', '../.env').splitlines() }}"

    - name: ðŸ“Œ Cargar usuario / contraseÃ±a de .env **y exponerlos a todo el play**
      set_fact:
        argocd_auth_user: "{{ (env_lines | select('match', '^ARGOCD_AUTH_USER=') | list).0.split('=')[1] }}"
        argocd_auth_pass: "{{ (env_lines | select('match', '^ARGOCD_AUTH_PASS=') | list).0.split('=')[1] }}"

    - name: ðŸ“‹ Verificar que kubeseal estÃ© instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortar si kubeseal no estÃ¡ instalado
      fail:
        msg: "âŒ kubeseal no estÃ¡ instalado en {{ kubeseal_path }}."
      when: not kubeseal_check.stat.exists

    - name: âš™ï¸ Verificar que usuario/contraseÃ±a estÃ¡n definidos
      fail:
        msg: "âŒ ARGOCD_AUTH_USER o ARGOCD_AUTH_PASS faltan en .env"
      when: argocd_auth_user == '' or argocd_auth_pass == ''

    # ------------------------------------------------------------------
    # â¶ Generar el Secret (unsealed) â· sellarlo â¸ aplicarlo al clÃºster
    # ------------------------------------------------------------------
    - name: ðŸ”‘ Generar hash htpasswd (bcrypt) y codificarlo en base-64
      shell: echo "{{ argocd_auth_pass }}" | htpasswd -i -B -n "{{ argocd_auth_user }}"
      register: basic_auth_string
      changed_when: false
      no_log: true

    - name: ðŸ“ Renderizar Secret sin sellar
      template:
        src: "../templates/secrets/basic-auth-secret.yaml.j2"
        dest: "{{ playbook_dir }}/files/argocd-secret-unsealed.yaml"
      vars:
        basic_auth: "{{ basic_auth_string.stdout | b64encode }}"
        namespace_tpl: "{{ argocd_namespace }}"
        secret_name: "{{ argocd_secret_name }}"

    - name: ðŸ” Sellar el Secret con kubeseal
      shell: >
        {{ kubeseal_path }} --controller-name sealed-secrets-controller
        --controller-namespace kube-system --format yaml
        < {{ playbook_dir }}/files/argocd-secret-unsealed.yaml
        > {{ playbook_dir }}/files/argocd-secret-sealed.yaml
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: ðŸš€ Aplicar SealedSecret
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
        apply -f {{ playbook_dir }}/files/argocd-secret-sealed.yaml
      register: secret_apply
      changed_when: "'created' in secret_apply.stdout or 'configured' in secret_apply.stdout"

  #######################################################################
  # â–‘â–‘â–‘â–‘â–‘â–‘  TAREAS PRINCIPALES: instalar ArgoCD e IngressRoute  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
  #######################################################################
  tasks:
    - name: ðŸ“¦ Instalar ArgoCD (chart + namespace + secret admin)
      import_playbook: 03_install_argocd.yml    # â† ahora se importa como playbook

    - name: ðŸŒ Crear IngressRoute con autenticaciÃ³n (Traefik CRD)
      import_playbook: 02_apply_argocd_ingressroute.yml

    - name: â±ï¸ Esperar a que el pod argocd-server estÃ© Â«RunningÂ»
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ argocd_namespace }}"
        label_selectors: ["app.kubernetes.io/name=argocd-server"]
      register: pods
      retries: 20
      delay: 10
      until: pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0

    - name: âœ… URL final
      debug:
        msg: "âœ… ArgoCD listo en https://{{ argocd_dashboard_domain }}"